###########################################
# Call Secret Manager Deployment Template #
###########################################

parameters:
  #####################
  # Common parameters #
  #####################
  h1: ""
  h2: ""
  baseURL: ""
  authToken: ""
  VERBOSE: ""
  SLEEP_TIMER: ""
  WORKSPACE: ""
  SCRIPTS_HOME: ""
  BUILD_USER_ID: ""
  #######################
  # Specific parameters #
  #######################
  env: ""
  secretMode: "boomi"
  secretName: "boomi-secrets"
  BOOMI_LIBRARIES: ""

steps:
  - script: |
      ####################
      # Common variables #
      ####################
      export h1="${{ parameters.h1 }}"
      export h2="${{ parameters.h2 }}"
      export baseURL="${{ parameters.baseURL }}"
      export authToken="${{ parameters.authToken }}"
      export VERBOSE="${{ parameters.VERBOSE }}"
      export SLEEP_TIMER="${{ parameters.SLEEP_TIMER }}"
      export WORKSPACE="${{ parameters.WORKSPACE }}"
      export SCRIPTS_HOME="${{ parameters.SCRIPTS_HOME }}"
      export BUILD_USER_ID="$(Build.Reason)"
      ######################
      # Specific variables #
      ######################
      export env="${{ parameters.env }}"
      export importer="com.boomi.proserv.security.secretmanager.importer.AzureSecretManager"
      #export importerParams="${{ parameters.secretName }} $env"
      export AZURE_KEY_VAULT_NAME="${{ parameters.secretName }}"
      #export importer="com.boomi.proserv.security.secretmanager.importer.AWSSecretManager"
      #export importerParams="${{ parameters.awsRegion }} boomi/$env"
      #export AWS_REGION="${{ parameters.awsRegion }}"
      #export AWS_ACCESS_KEY="${{ parameters.awsAccessKeyId }}"
      #export AWS_SECRET_ACCESS_KEY="${{ parameters.awsSecretKey }}"
      if [ ${{ parameters.secretMode }} = 'boomi' ]
        then
          export exporter="com.boomi.proserv.security.secretmanager.exporter.BoomiExtensionJSONExporter"
          export outputFile="${{ parameters.WORKSPACE }}/componentsExtracted.json"
      fi
      if [ ${{ parameters.secretMode }} = 'postman' ]
        then
          export exporter="com.boomi.proserv.security.secretmanager.exporter.PostmanGlobalExporter"
          export outputFile="${{ parameters.WORKSPACE }}/postman/My_Workspace.postman_globals.json"
      fi
      export BOOMI_LIBRARIES="${{ parameters.BOOMI_LIBRARIES }}"
      #############
      # Execution #
      #############
      echo "ARA: Moving to $(Build.Repository.LocalPath)"
      cd $(Build.Repository.LocalPath)
      chmod +x ci-templates/azuredevops/pipelines/*.sh
      bash -xe ci-templates/azuredevops/pipelines/call_secretmanager.sh
