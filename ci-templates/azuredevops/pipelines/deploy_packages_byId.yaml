#################################################
# Deploy Package by ID Template for Boomi      #
#################################################

parameters:
  #####################
  # Common parameters #
  #####################
  h1: ''
  h2: ''
  baseURL: ''
  authToken: ''
  VERBOSE: ''
  SLEEP_TIMER: ''
  WORKSPACE: ''
  SCRIPTS_HOME: ''
  #######################
  # Specific parameters #
  #######################
  packageId: ''
  env: ''
  notes: ''
  listenerStatus: 'RUNNING'

steps:
  - script: |
      ####################
      # Common variables #
      ####################
      export h1="${{ parameters.h1 }}"
      export h2="${{ parameters.h2 }}"
      export baseURL="${{ parameters.baseURL }}"
      export authToken="${{ parameters.authToken }}"
      export VERBOSE="${{ parameters.VERBOSE }}"
      export SLEEP_TIMER="${{ parameters.SLEEP_TIMER }}"
      export WORKSPACE="${{ parameters.WORKSPACE }}"
      export SCRIPTS_HOME="${{ parameters.SCRIPTS_HOME }}"
      export BUILD_USER="$(Build.RequestedFor)"
      export BUILD_USER_ID="$(Build.RequestedForEmail)"
      export BUILD_EVENT="$(Build.Reason)"
      ######################
      # Specific variables #
      ######################
      export packageId="${{ parameters.packageId }}"
      export env="${{ parameters.env }}"
      export notes="${{ parameters.notes }}"
      export listenerStatus="${{ parameters.listenerStatus }}"
      
      #############
      # Execution #
      #############
      echo "Deploying existing package by ID..."
      echo "Package ID: ${packageId}"
      echo "Environment: ${env}"
      echo "Listener Status: ${listenerStatus}"
      
      cd $(Build.Repository.LocalPath)
      
      # Query environment to get envId
      source ${SCRIPTS_HOME}/bin/queryEnvironment.sh env="${env}" classification="*"
      
      if [ "$ERROR" -gt 0 ]; then
        echo "❌ Failed to query environment: $ERROR_MESSAGE"
        exit 1
      fi
      
      echo "Environment ID: ${envId}"
      
      # Deploy the existing package (does NOT create new package)
      source ${SCRIPTS_HOME}/bin/createDeployedPackage.sh \
        envId="${envId}" \
        packageId="${packageId}" \
        listenerStatus="${listenerStatus}" \
        notes="${notes}"
      
      if [ "$ERROR" -gt 0 ]; then
        echo "❌ Deployment failed: $ERROR_MESSAGE"
        exit 1
      fi
      
      echo "✅ Package ${packageId} deployed successfully to ${env}"
    displayName: 'Deploy Package ${{ parameters.packageId }} to ${{ parameters.env }}'
