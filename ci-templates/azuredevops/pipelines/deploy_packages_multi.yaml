#################################################
# Deploy Multiple Packages by Version Template  #
#################################################

parameters:
  #####################
  # Common parameters #
  #####################
  h1: ""
  h2: ""
  baseURL: ""
  authToken: ""
  VERBOSE: ""
  SLEEP_TIMER: ""
  WORKSPACE: ""
  SCRIPTS_HOME: ""
  #######################
  # Specific parameters #
  #######################
  componentIds: ""
  packageVersion: ""
  env: ""
  notes: ""
  listenerStatus: "RUNNING"
  componentType: ""
  branchName: ""

steps:
  - script: |
      ####################
      # Common variables #
      ####################
      export h1="${{ parameters.h1 }}"
      export h2="${{ parameters.h2 }}"
      export baseURL="${{ parameters.baseURL }}"
      export authToken="${{ parameters.authToken }}"
      export VERBOSE="${{ parameters.VERBOSE }}"
      export SLEEP_TIMER="${{ parameters.SLEEP_TIMER }}"
      export WORKSPACE="${{ parameters.WORKSPACE }}"
      export SCRIPTS_HOME="${{ parameters.SCRIPTS_HOME }}"

      ######################
      # Specific variables #
      ######################
      export componentIds="${{ parameters.componentIds }}"
      export packageVersion="${{ parameters.packageVersion }}"
      export env="${{ parameters.env }}"
      export notes="${{ parameters.notes }}"
      export listenerStatus="${{ parameters.listenerStatus }}"
      export componentType="${{ parameters.componentType }}"
      # branchName might be needed but queryPackagedComponent doesn't seem to use it for query? 
      # Actually PackagedComponent query DOES supports branchName filtering if strict about it.
      # But our script ignores it for now or queryPackagedComponent.sh needs it.
      # Let's check queryPackagedComponent.sh - it uses inputs "$@" -> common.sh

      #############
      # Execution #
      #############
      echo "Deploying packages by Version..."
      echo "Component IDs: ${componentIds}"
      echo "Package Version: ${packageVersion}"
      echo "Environment: ${env}"

      cd ${SCRIPTS_HOME}

      # Use the multi-deploy script
      source bin/deployPackagesByVersion.sh \
        env="${env}" \
        packageVersion="${packageVersion}" \
        componentIds="${componentIds}" \
        listenerStatus="${listenerStatus}" \
        notes="${notes}" \
        componentType="${componentType}"

      RETURN_CODE=$?

      if [ "$ERROR" -gt 0 ] || [ "$RETURN_CODE" -ne 0 ]; then
        echo "❌ Deployment failed"
        exit 1
      fi

      echo "✅ All packages deployed successfully to ${env}"
    displayName: "Deploy Packages (${{ parameters.packageVersion }}) to ${{ parameters.env }}"
