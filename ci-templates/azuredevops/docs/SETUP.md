# Azure DevOps Setup Guide

This guide shows you how to set up the Boomi CI/CD CLI with Azure DevOps Pipelines.

## Prerequisites

1. **Azure DevOps Organization & Project**
2. **Self-hosted or Microsoft-hosted agent** with:
   - Bash (4.0+)
   - curl
   - jq
3. **Boomi Account Credentials**

## Setup Steps

### 1. Configure Variable Groups

Create two variable groups in Azure DevOps:

#### Variable Group: `boomicicd`
| Variable | Value | Secret |
|----------|-------|--------|
| `authToken` | Base64 encoded `BOOMI_ACCOUNT.username:token` | ‚úì |
| `baseURL` | `https://api.boomi.com/api/rest/v1/ACCOUNT_ID/` | |

#### Variable Group: `boomiruntime`
| Variable | Description | Example |
|----------|-------------|---------|
| `development_apim_envname` | Development environment ID | `env-dev-123` |
| `testing_apim_envname` | UAT environment ID | `env-uat-456` |
| `production_apim_envname` | Production environment ID | `env-prod-789` |
| `testing_apim_atom` | Testing atom name | `Test-Atom-01` |

### 2. Clone Repository and Configure Pipeline

1. Clone this repository to your Azure DevOps project
2. Copy the example pipeline:
   ```bash
   cp ci-templates/azuredevops/examples/azure-pipelines.yml azure-pipelines.yml
   ```

3. Edit `azure-pipelines.yml` to configure:
   - Agent pool (`pool.name`)
   - Component IDs or process names to deploy
   - Environment settings

### 3. Pipeline Structure

The example pipeline uses a custom template that orchestrates:
- **QA Deployment** ‚Üí Test ‚Üí Validation
- **UAT Deployment** ‚Üí Test ‚Üí API Testing
- **Production Deployment** (conditional)

```yaml
trigger:
  - main

pool:
  name: 'Default'

variables:
  - group: boomicicd
  - group: boomiruntime
  - name: SCRIPTS_HOME
    value: $(Build.SourcesDirectory)/cli/scripts
  - name: WORKSPACE
    value: $(Build.SourcesDirectory)/workspace

steps:
  - script: |
      mkdir -p $(WORKSPACE)
      chmod +x $(SCRIPTS_HOME)/bin/*.sh
      chmod +x $(Build.SourcesDirectory)/ci-templates/azuredevops/pipelines/*.sh
    displayName: 'Prepare Workspace and Scripts'

  - template: ci-templates/azuredevops/pipelines/deploy_packages.yaml
    parameters:
      packageName: 'BoomiPackage'
      packageVersion: '$(Build.BuildNumber)'
      componentIds: 'component-id-1,component-id-2'
```

### 4. Available Templates

#### Build-Once-Deploy-Many Templates (Recommended for Production)

| Template | Purpose |
|----------|---------|
| `base_build_approval_deploy.yaml` | ‚úÖ **RECOMMENDED** - Complete pipeline with build-once pattern and approval gates |
| `create_packages.yaml` | Build package once and export packageId |
| `deploy_packages_byId.yaml` | Deploy existing package by ID (does NOT create new package) |
| `undeploy_packages_byId.yaml` | Undeploy package by ID |

> **üìñ See [BUILD_ONCE_PATTERN.md](BUILD_ONCE_PATTERN.md) for detailed guide on build-once-deploy-many pattern**

#### Quick Deploy Templates (Recommended for Development and QA)

| Template | Purpose | Note |
|----------|---------|------|
| `deploy_packages.yaml` | Deploy packaged components | Creates NEW package then deploys |
| `undeploy_packages.yaml` | Undeploy packages from environment | By component ID |

#### Utility Templates

| Template | Purpose |
|----------|---------|
| `get_components.yaml` | Retrieve component IDs from Boomi |
| `execute_processes.yaml` | Execute processes on an atom |
| `validate_processes.yaml` | Validate process execution results |
| `call_api.yaml` | Run Postman collections for API testing |
| `call_secretmanager.yaml` | Retrieve secrets from Azure Key Vault or AWS Secrets Manager |
| `retrieve_extensions.yaml` | Retrieve environment extensions |
| `update_extensions.yaml` | Update environment extensions |
| `clean_up.yaml` | Cleanup temporary files |


### 5. Triggering a Deployment

1. **From Pipeline UI**: Manually trigger with parameters
2. **From Code**: Push to the configured branch (e.g., `main`)
3. **Via API**: Use Azure DevOps REST API

### 6. Monitoring

- View logs in Azure DevOps pipeline runs
- Check `$(WORKSPACE)/out.json` for API responses
- Review HTML reports generated by publish scripts

## Common Configuration Patterns

### Deploy Specific Components
```yaml
- template: ci-templates/azuredevops/pipelines/deploy_packages.yaml
  parameters:
    componentIds: 'abc-123,def-456'
    env: $(development_apim_envname)
    packageVersion: '1.0.0'
    notes: 'Hotfix deployment'
```

### Deploy by Process Name
```yaml
- template: ci-templates/azuredevops/pipelines/deploy_packages.yaml
  parameters:
    processNames: 'ProcessA,ProcessB'
    env: $(testing_apim_envname)
    packageVersion: '$(Build.BuildNumber)'
```

## Troubleshooting

### Error: `jq: command not found`
Install jq on your agent:
```bash
# Ubuntu/Debian
sudo apt-get install jq

# RHEL/CentOS
sudo yum install jq
```

### Error: Permission denied
Ensure scripts are executable:
```bash
chmod +x cli/scripts/bin/*.sh
chmod +x ci-templates/azuredevops/pipelines/*.sh
```

### Error: Authentication failed
Verify your `authToken` in the `boomicicd` variable group is correctly formatted:
```
Base64(BOOMI_ACCOUNT.username:api_token)
```

## Next Steps

- Review [CLI Reference](../../docs/CLI_REFERENCE.md) for all available commands
- Explore [Common Workflows](../../examples/common-workflows/) for more patterns
- Customize templates for your specific deployment strategy

---

## Advanced: Build-Once-Deploy-Many Pattern

The **recommended approach** for production deployments is the build-once-deploy-many pattern using `base_build_approval_deploy.yaml`.

### Why Build-Once?

**Problem with multiple builds:**
- QA gets package `pkg-qa-123`
- UAT gets package `pkg-uat-456` (different!)
- Prod gets package `pkg-prod-789` (different!)
- ‚ùå Can't guarantee what's in production

**Build-once solution:**
- Package built ONCE: `pkg-12345`
- QA deploys: `pkg-12345`
- UAT deploys: `pkg-12345` (same!)
- Prod deploys: `pkg-12345` (same!)
- ‚úÖ Same artifact everywhere

### Quick Start

**1. Use the example:**
```bash
cp ci-templates/azuredevops/examples/dummy-api.yaml my-api.yaml
```

**2. Configure your components:**
```yaml
extends:
  template: templates/base_build_approval_deploy.yaml
  parameters:
    packageName: 'my-api'
    componentIds: 'comp-id-1,comp-id-2'  # Find with queryProcess.sh
    deployToQA: true
    deployToUAT: true
    deployToProd: true
```

**3. Configure approval gates** (5 minutes):
- Create environments: UAT, Production
- Add approvers for each environment
- See detailed steps in [BUILD_ONCE_PATTERN.md](BUILD_ONCE_PATTERN.md)

### üìñ Complete Documentation

> **See [BUILD_ONCE_PATTERN.md](BUILD_ONCE_PATTERN.md) for:**
> - Detailed build-once-deploy-many guide
> - Step-by-step approval configuration
> - Mermaid flowchart of pipeline stages
> - Migration guide from old patterns
> - Troubleshooting
> - Best practices

---

## Configuring Approvals and Gates

> **üìñ For detailed approval configuration, see [BUILD_ONCE_PATTERN.md ¬ß "Setting Up Approval Gates"](BUILD_ONCE_PATTERN.md#setting-up-approval-gates)**

### Quick Reference

**Step 1: Create Environments**
1. Pipelines ‚Üí Environments ‚Üí New environment
2. Create: `UAT` and `Production`

**Step 2: Add Approvers**
- UAT: Lead Integration Members (min 1 approver)
- Production: Product/Deployment Managers (min 2 approvers)

**Step 3: Configure Checks** (Optional)
- Business hours restriction
- Branch control (main, release/* only)

### Role-Based Approvals

Configure who can approve based on Azure AD groups:

**Create Approval Groups:**

1. **Azure Active Directory** ‚Üí **Groups** ‚Üí **New group**
2. Create groups:
   - `Boomi-QA-Approvers` (for QA deployments)
   - `Boomi-UAT-Approvers` (for UAT deployments)
   - `Boomi-Prod-Approvers` (for production deployments)

**Assign to Environments:**

1. Navigate to **Production** environment
2. **Approvals and checks** ‚Üí **Approvals** ‚Üí **Edit**
3. **Approvers**: Add `Boomi-Prod-Approvers` group
4. Set **Minimum number of approvers** based on risk:
   - Critical systems: `2` approvers
   - Standard systems: `1` approver

**Environment Permissions:**

1. Environment ‚Üí **‚ãÆ** ‚Üí **Security**
2. Add groups with specific permissions:
   - `Boomi-Prod-Approvers`: **Approver** role
   - `Boomi-Developers`: **Reader** role (view only)
   - `Boomi-Release-Managers`: **Administrator** role

### 7. Approval Notifications

Configure notifications for approval requests:

1. **Project Settings** ‚Üí **Notifications**
2. **New subscription** ‚Üí **Build and release**
3. Choose: **Deployment pending**
4. Add recipients: Approval groups or individuals
5. **Save**

### 8. Best Practices

‚úÖ **Multiple Approvers for Prod**: Require 2+ approvals for production

‚úÖ **Separate Approval Groups**: Different groups for QA/UAT/Prod

‚úÖ **Time Windows**: Restrict prod deployments to business hours or maintenance windows

‚úÖ **Audit Trail**: Azure DevOps logs all approvals with timestamp and approver

‚úÖ **Approval Timeout**: Set realistic timeouts (24-48 hours for prod)

‚úÖ **Reject with Comments**: Approvers should document rejection reasons

‚úÖ **Post-Deployment Validation**: Add monitoring checks after production deployment

### 9. Example: Complete Approval Flow

```
Developer pushes to main branch
        ‚Üì
Pipeline triggers automatically
        ‚Üì
Preparation stage: Get components
        ‚Üì
[Manual trigger: deployToQA=true]
        ‚Üì
QA_Deployment: Deploy to QA
        ‚Üì
QA_Testing: Run tests
        ‚Üì
QA_APITesting: Validate APIs
        ‚Üì
[Manual trigger: deployToUAT=true]
        ‚Üì
UAT_Deployment: Deploy to UAT
        ‚Üì
UAT_Testing: Run UAT tests
        ‚Üì
UAT_APITesting: Validate UAT APIs
        ‚Üì
UAT_Completion: Emulator tests
        ‚Üì
[Manual trigger: deployToProd=true]
        ‚Üì
‚è∏Ô∏è  PAUSED: Waiting for Production approval
        ‚Üì
Email sent to Boomi-Prod-Approvers group
        ‚Üì
Approver reviews test results
        ‚Üì
Approver clicks "Approve"
        ‚Üì
Prod_Deployment: Deploy to production
        ‚Üì
Cleanup: Test_Testing_Teardown
        ‚Üì
‚úÖ Pipeline completed
```

### 10. Troubleshooting Approvals

**Approval not triggered:**
- Verify `environment: Production` is set in deployment job
- Check environment exists in Azure DevOps
- Ensure stage dependencies are correct

**Approvers not notified:**
- Check notification settings
- Verify approvers have permissions
- Check spam/junk folders for emails

**Deployment skipped:**
- Verify `deployToProd` parameter is `true`
- Check conditional expressions in template
- Review stage dependencies

---

## Next Steps
